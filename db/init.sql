-- Initialize single Postgres database as a "data hub"
-- Creates service-specific schemas and objects inside one DB: data_hub

-- Create schemas (names mirror your service names)
CREATE SCHEMA IF NOT EXISTS customer_service_db;
CREATE SCHEMA IF NOT EXISTS employee_service_db;
CREATE SCHEMA IF NOT EXISTS vehicle_service_db;
CREATE SCHEMA IF NOT EXISTS appointment_service_db;
CREATE SCHEMA IF NOT EXISTS service_management_db;

-- Reusable trigger function to update updated_at
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ==========================
-- CUSTOMER SERVICE (schema)
-- ==========================
CREATE TABLE IF NOT EXISTS customer_service_db.customer (
    customer_id INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    name VARCHAR(200),
    email VARCHAR(150) UNIQUE,
    phone VARCHAR(50),
    password_hash VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ==========================
-- EMPLOYEE SERVICE (schema)
-- ==========================
CREATE TABLE IF NOT EXISTS employee_service_db.employee (
    employee_id INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    name VARCHAR(200),
    email VARCHAR(150) UNIQUE,
    password_hash VARCHAR(255),
    role VARCHAR(100),
    photo_url TEXT,
    status VARCHAR(50),
    hourly_rate DECIMAL(10,2),
    specialization VARCHAR(200),
    hire_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS employee_service_db.time_log (
    log_id INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    employee_id INT,
    work_type VARCHAR(100),
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    duration_minutes INT,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_time_log_employee
        FOREIGN KEY (employee_id) REFERENCES employee_service_db.employee(employee_id)
);

-- ==========================
-- VEHICLE SERVICE (schema)
-- ==========================
CREATE TABLE IF NOT EXISTS vehicle_service_db.vehicle (
    vehicle_id INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    customer_id INT,
    vin VARCHAR(100) UNIQUE,
    license_plate VARCHAR(50),
    model VARCHAR(100),
    make VARCHAR(100),
    year INT,
    color VARCHAR(50),
    mileage INT,
    status VARCHAR(50),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_vehicle_customer
        FOREIGN KEY (customer_id) REFERENCES customer_service_db.customer(customer_id)
);

-- =============================
-- APPOINTMENT SERVICE (schema)
-- =============================
CREATE TABLE IF NOT EXISTS appointment_service_db.appointment (
    appointment_id INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    customer_id INT,
    vehicle_id INT,
    appointment_date TIMESTAMP,
    time_slot VARCHAR(100),
    service_type VARCHAR(100),
    status VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_appointment_customer
        FOREIGN KEY (customer_id) REFERENCES customer_service_db.customer(customer_id),
    CONSTRAINT fk_appointment_vehicle
        FOREIGN KEY (vehicle_id) REFERENCES vehicle_service_db.vehicle(vehicle_id)
);

-- Trigger to maintain updated_at on appointment
DROP TRIGGER IF EXISTS update_appointment_updated_at ON appointment_service_db.appointment;
CREATE TRIGGER update_appointment_updated_at
BEFORE UPDATE ON appointment_service_db.appointment
FOR EACH ROW
EXECUTE FUNCTION public.update_updated_at_column();

-- ============================
-- SERVICE MANAGEMENT (schema)
-- ============================
CREATE TABLE IF NOT EXISTS service_management_db.service (
    service_id INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    vehicle_id INT,
    assigned_to INT,
    service_type VARCHAR(100),
    description TEXT,
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    estimated_cost DECIMAL(12,2),
    actual_cost DECIMAL(12,2),
    completion_percentage DECIMAL(5,2),
    notes TEXT,
    status VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_service_vehicle
        FOREIGN KEY (vehicle_id) REFERENCES vehicle_service_db.vehicle(vehicle_id),
    CONSTRAINT fk_service_employee
        FOREIGN KEY (assigned_to) REFERENCES employee_service_db.employee(employee_id)
);

-- Trigger to maintain updated_at on service
DROP TRIGGER IF EXISTS update_service_updated_at ON service_management_db.service;
CREATE TRIGGER update_service_updated_at
BEFORE UPDATE ON service_management_db.service
FOR EACH ROW
EXECUTE FUNCTION public.update_updated_at_column();

CREATE TABLE IF NOT EXISTS service_management_db.service_update (
    update_id INT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    service_id INT,
    progress_percentage DECIMAL(5,2),
    update_text TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_service_update_service
        FOREIGN KEY (service_id) REFERENCES service_management_db.service(service_id)
);

-- =====================================
-- SEED DATA (matches your provided rows)
-- =====================================
-- Customers
INSERT INTO customer_service_db.customer (first_name, last_name, name, email, phone, password_hash) VALUES
('Malina', 'Rathnayaka', 'Malina Rathnayaka', 'malina@example.com', '+94771234567', 'hashed_pw1'),
('Lihaj', 'Perera', 'Lihaj Perera', 'lihaj@example.com', '+94776543210', 'hashed_pw2'),
('Kasun', 'Fernando', 'Kasun Fernando', 'kasun@example.com', '+94770001122', 'hashed_pw3'),
('Nimali', 'Jayasinghe', 'Nimali Jayasinghe', 'nimali@example.com', '+94778889900', 'hashed_pw4'),
('Ravindu', 'Silva', 'Ravindu Silva', 'ravindu@example.com', '+94775556677', 'hashed_pw5');

-- Employees
INSERT INTO employee_service_db.employee (first_name, last_name, name, email, password_hash, role, photo_url, status, hourly_rate, specialization, hire_date) VALUES
('Tharindu', 'Wijesinghe', 'Tharindu Wijesinghe', 'tharindu@garage.com', 'hashed_emp1', 'Mechanic', 'https://picsum.photos/100/100?1', 'Active', 1200.00, 'Engine Repair', '2021-05-10'),
('Shehani', 'Perera', 'Shehani Perera', 'shehani@garage.com', 'hashed_emp2', 'Technician', 'https://picsum.photos/100/100?2', 'Active', 1000.00, 'Electrical Systems', '2022-03-15'),
('Nuwan', 'Silva', 'Nuwan Silva', 'nuwan@garage.com', 'hashed_emp3', 'Service Advisor', 'https://picsum.photos/100/100?3', 'Active', 950.00, 'Customer Support', '2020-10-20'),
('Ishara', 'Dissanayake', 'Ishara Dissanayake', 'ishara@garage.com', 'hashed_emp4', 'Painter', 'https://picsum.photos/100/100?4', 'Inactive', 800.00, 'Body Painting', '2019-08-01'),
('Amal', 'Jayawardena', 'Amal Jayawardena', 'amal@garage.com', 'hashed_emp5', 'Manager', 'https://picsum.photos/100/100?5', 'Active', 1500.00, 'Operations Management', '2018-02-25');

INSERT INTO employee_service_db.time_log (employee_id, work_type, start_time, end_time, duration_minutes, description) VALUES
(1, 'Repair', '2025-11-06 08:30:00', '2025-11-06 12:00:00', 210, 'Engine oil replacement and diagnostics'),
(2, 'Electrical', '2025-11-06 09:00:00', '2025-11-06 11:00:00', 120, 'Battery testing and alternator repair'),
(3, 'Customer Support', '2025-11-06 08:00:00', '2025-11-06 16:00:00', 480, 'Handled customer appointments'),
(1, 'Repair', '2025-11-07 09:00:00', '2025-11-07 13:30:00', 270, 'Brake system maintenance'),
(5, 'Management', '2025-11-07 08:00:00', '2025-11-07 17:00:00', 540, 'Supervised garage operations');

-- Vehicles
INSERT INTO vehicle_service_db.vehicle (customer_id, vin, license_plate, model, make, year, color, mileage, status) VALUES
(1, '1HGCM82633A004352', 'CBA-1023', 'Civic', 'Honda', 2020, 'Blue', 45000, 'Active'),
(2, '2T1BURHE5FC258741', 'KDA-7744', 'Corolla', 'Toyota', 2019, 'White', 60000, 'Active'),
(3, '3FA6P0HD9ER123456', 'SPB-2211', 'Fusion', 'Ford', 2021, 'Gray', 30000, 'Active'),
(4, '4T1BE46K67U654321', 'CAR-5666', 'Camry', 'Toyota', 2018, 'Black', 80000, 'Inactive'),
(5, 'JH4KA2650MC000789', 'LKA-8877', 'Accord', 'Honda', 2022, 'Red', 15000, 'Active');

-- Appointments
INSERT INTO appointment_service_db.appointment (customer_id, vehicle_id, appointment_date, time_slot, service_type, status) VALUES
(1, 1, '2025-11-08 09:00:00', '09:00-10:00', 'Engine Checkup', 'Scheduled'),
(2, 2, '2025-11-08 11:00:00', '11:00-12:00', 'Oil Change', 'Pending'),
(3, 3, '2025-11-09 10:30:00', '10:30-11:30', 'Brake Inspection', 'Scheduled'),
(4, 4, '2025-11-09 14:00:00', '14:00-15:00', 'Body Painting', 'Completed'),
(5, 5, '2025-11-10 13:00:00', '13:00-14:00', 'Full Service', 'Pending');

-- Services
INSERT INTO service_management_db.service (vehicle_id, assigned_to, service_type, description, start_time, end_time, estimated_cost, actual_cost, completion_percentage, notes, status) VALUES
(1, 1, 'Engine Checkup', 'Full engine diagnostics and oil replacement', '2025-11-08 09:00:00', '2025-11-08 11:30:00', 15000.00, 14800.00, 100.00, 'Completed successfully', 'Completed'),
(2, 2, 'Oil Change', 'Engine oil and filter change', '2025-11-08 11:00:00', '2025-11-08 12:00:00', 5000.00, 0.00, 0.00, 'Awaiting vehicle arrival', 'Pending'),
(3, 1, 'Brake Inspection', 'Check and replace brake pads if needed', '2025-11-09 10:30:00', NULL, 8000.00, 0.00, 40.00, 'Inspection started', 'In Progress'),
(4, 4, 'Body Painting', 'Scratch removal and full-body paint', '2025-11-09 14:00:00', '2025-11-10 17:00:00', 30000.00, 29000.00, 100.00, 'Completed with minor adjustments', 'Completed'),
(5, 5, 'Full Service', 'General vehicle inspection and maintenance', '2025-11-10 13:00:00', NULL, 12000.00, 0.00, 20.00, 'Engine inspection started', 'In Progress');

INSERT INTO service_management_db.service_update (service_id, progress_percentage, update_text) VALUES
(1, 50.00, 'Engine diagnostics complete'),
(1, 100.00, 'Oil replaced and tested'),
(3, 20.00, 'Brake system inspection started'),
(3, 40.00, 'Front brake pads replaced'),
(5, 10.00, 'Vehicle received and washing started');


